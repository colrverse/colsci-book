<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 2 Importing, Processing, and Visualising Data | The pavo handbook: studying biological colouration in R</title>
<meta name="generator" content="bookdown 0.39.1 with bs4_book()">
<meta property="og:title" content="Chapter 2 Importing, Processing, and Visualising Data | The pavo handbook: studying biological colouration in R">
<meta property="og:type" content="book">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 2 Importing, Processing, and Visualising Data | The pavo handbook: studying biological colouration in R">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.7.0/transition.js"></script><script src="libs/bs3compat-0.7.0/tabs.js"></script><script src="libs/bs3compat-0.7.0/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<style type="text/css">
    /* Used with Pandoc 2.11+ new --citeproc when CSL is used */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
          margin-bottom: 0em;
        }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
<link rel="stylesheet" href="style.css">
<meta name="description" content="2.1 Organizing Spectral Data Let’s begin by loading the package. # Load the package, and set a global # random-number seed for the reproducible # generation of fake data later on. library(pavo)...">
<meta property="og:description" content="2.1 Organizing Spectral Data Let’s begin by loading the package. # Load the package, and set a global # random-number seed for the reproducible # generation of fake data later on. library(pavo)...">
<meta name="twitter:description" content="2.1 Organizing Spectral Data Let’s begin by loading the package. # Load the package, and set a global # random-number seed for the reproducible # generation of fake data later on. library(pavo)...">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">The pavo handbook: studying biological colouration in R</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html"><span class="header-section-number">1</span> Package Overview</a></li>
<li><a class="active" href="importing-processing-and-visualising-data.html"><span class="header-section-number">2</span> Importing, Processing, and Visualising Data</a></li>
<li><a class="" href="analysing-data.html"><span class="header-section-number">3</span> Analysing Data</a></li>
<li><a class="" href="spectral-shape-descriptors.html"><span class="header-section-number">4</span> Spectral shape descriptors</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/colrverse/colsci-book">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="importing-processing-and-visualising-data" class="section level1" number="2">
<h1>
<span class="header-section-number">2</span> Importing, Processing, and Visualising Data<a class="anchor" aria-label="anchor" href="#importing-processing-and-visualising-data"><i class="fas fa-link"></i></a>
</h1>
<div id="organizing-spectral-data" class="section level2" number="2.1">
<h2>
<span class="header-section-number">2.1</span> Organizing Spectral Data<a class="anchor" aria-label="anchor" href="#organizing-spectral-data"><i class="fas fa-link"></i></a>
</h2>
<p>Let’s begin by loading the package.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load the package, and set a global</span></span>
<span><span class="co"># random-number seed for the reproducible</span></span>
<span><span class="co"># generation of fake data later on.</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://pavo.colrverse.com">pavo</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1612217</span><span class="op">)</span></span></code></pre></div>
<div id="spectral-dataset-description" class="section level3" number="2.1.1">
<h3>
<span class="header-section-number">2.1.1</span> Spectral Dataset Description<a class="anchor" aria-label="anchor" href="#spectral-dataset-description"><i class="fas fa-link"></i></a>
</h3>
<p>The raw spectral data used in this example are available from the package repository on <a href="https://github.com/rmaia/pavo">github</a>, located <a href="https://github.com/rmaia/pavo/tree/master/data_external/vignette">here</a>. You can download and extract it to follow the vignette exactly. Alternatively, the data are included as an RData file as part of the package installation, and so can be loaded directly (see below).</p>
<p>The data consist of reflectance spectra, obtained using Avantes equipment and software, from seven bird species: Northern Cardinal <em>Cardinalis cardinalis</em>, Wattled Jacana <em>Jacana jacana</em>, Baltimore Oriole <em>Icterus galbula</em>, Peach-fronted Parakeet <em>Aratinga aurea</em>, American Robin <em>Turdus migratorius</em>, and Sayaca Tanager <em>Thraupis sayaca</em>. Several individuals were measured (sample size varies by species), and 3 spectra were collected from each individual. However, the number of individuals measured per species is uneven and the data have additional peculiarities that should emphasize the flexibility <code>pavo</code> offers, as we’ll see below.</p>
<p>In addition, <code>pavo</code> includes three datasets that can be called with the <code><a href="https://rdrr.io/r/utils/data.html">data()</a></code> function. <code>data(teal)</code>, <code>data(sicalis)</code>, and <code>data(flowers)</code> will all be used in this vignette. See the help files for each dataset for more information; via <code><a href="http://pavo.colrverse.com/reference/teal.html">?teal</a></code>, <code><a href="http://pavo.colrverse.com/reference/sicalis.html">?sicalis</a></code>, and <code><a href="http://pavo.colrverse.com/reference/flowers.html">?flowers</a></code>.</p>
</div>
<div id="importing-spectra" class="section level3" number="2.1.2">
<h3>
<span class="header-section-number">2.1.2</span> Importing spectra<a class="anchor" aria-label="anchor" href="#importing-spectra"><i class="fas fa-link"></i></a>
</h3>
<p>The first thing we need to do is import spectral data into R using the function <code><a href="http://pavo.colrverse.com/reference/getspec.html">getspec()</a></code>. It’s worth noting that <code><a href="http://pavo.colrverse.com/reference/getspec.html">getspec()</a></code> is simply a wrapper for <code>lr_get_spec()</code> from the package <a href="https://docs.ropensci.org/lightr/"><code>lightr</code></a>, which is a more specialised and feature-rich package for the import of spectral data and metadata <span class="citation">(<a href="references.html#ref-gruson2019">Gruson, White, and Maia 2019</a>)</span>. Since the example spectra were obtained using Avantes software, we will need to specify that the files have the <code>.ttt</code> extension. Further, the data is organized in subdirectories for each species. <code><a href="http://pavo.colrverse.com/reference/getspec.html">getspec()</a></code> will search through subdirectories recursively, and may include the names of the subdirectories in the spectra name if desired. <code><a href="http://pavo.colrverse.com/reference/getspec.html">getspec()</a></code> also uses parallel processing thanks to the <code>future</code> package. You can check the documentation (<code>?future::plan()</code>) for more details but an easy way to set up parallel processing in most cases is to use the <code>plan("multiprocess")</code> command. A final issue with the data is that it was collected using a computer with international numbering input, which means it uses commas instead of periods as a decimal separator. We can specify that in the function call.</p>
<p>If, for example, the raw spectral files were downloaded and placed in a directory called <code>/pavo/data_external/vignette</code>, you might execute the following command and see this output:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">specs</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://pavo.colrverse.com/reference/getspec.html">getspec</a></span><span class="op">(</span><span class="st">"~/pavo/data_external/vignette"</span>,</span>
<span>  ext <span class="op">=</span> <span class="st">"ttt"</span>,</span>
<span>  decimal <span class="op">=</span> <span class="st">","</span>,</span>
<span>  subdir <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  subdir.names <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># 213  files found; importing spectra</span></span>
<span><span class="co"># |================================================================================| 100%, ETA 00:00</span></span></code></pre></div>
<p>For convenience, however, we’ve included the spectra as an RData file in the package installation, and so will simply load it directly.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">specs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"extdata/specsdata.rds"</span>,</span>
<span>  package <span class="op">=</span> <span class="st">"pavo"</span></span>
<span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>And we can inspect the resulting object:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># The data set has 213 spectra,</span></span>
<span><span class="co"># from 300 to 700 nm, plus a 'wl' column</span></span>
<span><span class="va">specs</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span></span></code></pre></div>
<pre><code>#&gt;     wl cardinal.0001 cardinal.0002 cardinal.0003
#&gt; 1  300        5.7453        8.0612        8.0723
#&gt; 2  301        6.0181        8.3926        8.8669
#&gt; 3  302        5.9820        8.8280        9.0680
#&gt; 4  303        6.2916        8.7621        8.7877
#&gt; 5  304        6.6277        8.6819        9.3450
#&gt; 6  305        6.3347        9.6016        9.4834
#&gt; 7  306        6.3189        9.5712        9.3533
#&gt; 8  307        6.7951        9.4650        9.9492
#&gt; 9  308        7.0758        9.4677        9.8587
#&gt; 10 309        7.2126       10.6172       10.5396</code></pre>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">specs</span><span class="op">)</span></span></code></pre></div>
<pre><code>#&gt; [1] 401 214</code></pre>
<p>When <code>pavo</code> imports spectra, it creates an object of class <code>rspec</code>, which inherits attributes from the <code>data.frame</code> class:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="http://pavo.colrverse.com/reference/as.rspec.html">is.rspec</a></span><span class="op">(</span><span class="va">specs</span><span class="op">)</span></span></code></pre></div>
<pre><code>#&gt; [1] TRUE</code></pre>
<p>If you already have multiple spectra in a single data frame that you’d like to use with <code>pavo</code> functions, you can use the command <code><a href="http://pavo.colrverse.com/reference/as.rspec.html">as.rspec()</a></code> to convert it to an rspec object. The function will attempt to identify the wavelength variable or you can specify the column containing wavelengths with the <code>whichwl</code> argument. The default way that <code><a href="http://pavo.colrverse.com/reference/as.rspec.html">as.rspec()</a></code> handles reflectance data is to interpolate the data in 1-nm bins, as is commonly done for spectral analyses. However, this can be turned off by using: <code>interp = FALSE</code>. As an example, we will create some fake reflectance data (n.b. we could use <code><a href="http://pavo.colrverse.com/reference/simulate_spec.html">simulate_spec()</a></code>, but the results would already be an <code>rspec</code> object), name the column containing wavelengths (in 0.5-nm bins) <em>wavelength</em> rather than <em>wl</em> (required for <code>pavo</code> functions to work) and also put the column containing wavelengths third rather than first.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create some fake reflectance data with</span></span>
<span><span class="co"># wavelength column arbitrarily titled</span></span>
<span><span class="co"># and not first in the data frame:</span></span>
<span><span class="va">fakedat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>  refl1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">801</span><span class="op">)</span>,</span>
<span>  refl2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">801</span><span class="op">)</span>,</span>
<span>  wavelength <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">300</span>, <span class="fl">700</span>, by <span class="op">=</span> <span class="fl">.5</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">fakedat</span><span class="op">)</span></span></code></pre></div>
<pre><code>#&gt;          refl1      refl2 wavelength
#&gt; 1 -0.032893386  0.5059612      300.0
#&gt; 2 -0.478552738 -1.1526035      300.5
#&gt; 3 -0.190687886 -1.0708952      301.0
#&gt; 4 -0.008977959 -1.9871907      301.5
#&gt; 5 -0.443133039 -0.3910143      302.0
#&gt; 6  0.032110206 -0.5403221      302.5</code></pre>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="http://pavo.colrverse.com/reference/as.rspec.html">is.rspec</a></span><span class="op">(</span><span class="va">fakedat</span><span class="op">)</span></span></code></pre></div>
<pre><code>#&gt; [1] FALSE</code></pre>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fakedat.new</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://pavo.colrverse.com/reference/as.rspec.html">as.rspec</a></span><span class="op">(</span><span class="va">fakedat</span><span class="op">)</span></span></code></pre></div>
<pre class="cm"><code>#&gt; wavelengths found in column 3</code></pre>
<pre class="cm"><code>#&gt; The spectral data contain 443 negative value(s),
#&gt;  which may produce unexpected results if used in models.
#&gt; Consider using procspec() to correct them.</code></pre>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="http://pavo.colrverse.com/reference/as.rspec.html">is.rspec</a></span><span class="op">(</span><span class="va">fakedat.new</span><span class="op">)</span></span></code></pre></div>
<pre><code>#&gt; [1] TRUE</code></pre>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">fakedat.new</span><span class="op">)</span></span></code></pre></div>
<pre><code>#&gt;    wl       refl1       refl2
#&gt; 1 300 -0.03289339  0.50596119
#&gt; 2 301 -0.19068789 -1.07089518
#&gt; 3 302 -0.44313304 -0.39101435
#&gt; 4 303 -0.52064707  0.84403232
#&gt; 5 304  1.42813472  0.07150436
#&gt; 6 305 -0.19044804 -0.84504226</code></pre>
<p>As can be seen, <code><a href="http://pavo.colrverse.com/reference/as.rspec.html">as.rspec()</a></code> renames the column containing wavelengths, sets it as the first column, interpolates the data in 1-nm bins and converts the data to an <code>rspec</code> object. Note that the same output is returned with specifying <code>whichwl = 3</code>:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fu"><a href="http://pavo.colrverse.com/reference/as.rspec.html">as.rspec</a></span><span class="op">(</span><span class="va">fakedat</span>, whichwl <span class="op">=</span> <span class="st">"wavelength"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre class="cm"><code>#&gt; The spectral data contain 443 negative value(s),
#&gt;  which may produce unexpected results if used in models.
#&gt; Consider using procspec() to correct them.</code></pre>
<pre><code>#&gt;    wl       refl1       refl2
#&gt; 1 300 -0.03289339  0.50596119
#&gt; 2 301 -0.19068789 -1.07089518
#&gt; 3 302 -0.44313304 -0.39101435
#&gt; 4 303 -0.52064707  0.84403232
#&gt; 5 304  1.42813472  0.07150436
#&gt; 6 305 -0.19044804 -0.84504226</code></pre>
<p>Finally, the <code>lim</code> argument allows you to specify the range of wavelengths contained in the input dataset. This is useful either in the case that the dataset doesn’t contain this information (and hence you cannot specify the column with <code>whichwl</code> or automatically find the column with <code><a href="http://pavo.colrverse.com/reference/as.rspec.html">as.rspec()</a></code>). Additionally, it may be useful to focus on a subset of wavelengths. In our example, the wavelengths ranged from 300 to 700 nm, however you could also specify a restricted range of wavelengths with <code>lim</code>:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fakedat.new2</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://pavo.colrverse.com/reference/as.rspec.html">as.rspec</a></span><span class="op">(</span><span class="va">fakedat</span>, lim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">300</span>, <span class="fl">500</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre class="cm"><code>#&gt; wavelengths found in column 3</code></pre>
<pre class="cm"><code>#&gt; The spectral data contain 231 negative value(s),
#&gt;  which may produce unexpected results if used in models.
#&gt; Consider using procspec() to correct them.</code></pre>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">refl1</span> <span class="op">~</span> <span class="va">wl</span>, type <span class="op">=</span> <span class="st">"l"</span>, data <span class="op">=</span> <span class="va">fakedat.new2</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="colsci-book_files/figure-html/unnamed-chunk-11-1.png" width="480" style="display: block; margin: auto;"></div>
<p>We want to stress that it is important to check the actual wavelengths contained in the data before setting this argument (<code><a href="http://pavo.colrverse.com/reference/as.rspec.html">as.rspec()</a></code> will warn you when wavelengths in the data are not present in the range specified with <code>lim</code>), otherwise <code><a href="http://pavo.colrverse.com/reference/as.rspec.html">as.rspec()</a></code> will assume that wavelengths exist when in fact they may not. For example, if we set <code>lim = c(300, 1000)</code> and plot the results, the reflectance values between 700 and 1000 nm are set to be equal since there is no information at these wavelengths in the original dataset:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fakedat.new2</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://pavo.colrverse.com/reference/as.rspec.html">as.rspec</a></span><span class="op">(</span><span class="va">fakedat</span>, lim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">300</span>, <span class="fl">1000</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre class="cm"><code>#&gt; wavelengths found in column 3</code></pre>
<pre class="cw"><code>#&gt; Warning: Interpolating beyond the range of actual data.
#&gt; Check 'lim' and `exceed.range` arguments to confirm this is the desired behaviour.</code></pre>
<pre class="cm"><code>#&gt; The spectral data contain 743 negative value(s),
#&gt;  which may produce unexpected results if used in models.
#&gt; Consider using procspec() to correct them.</code></pre>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">fakedat.new2</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">~</span> <span class="va">fakedat.new2</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, type <span class="op">=</span> <span class="st">"l"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="colsci-book_files/figure-html/unnamed-chunk-12-1.png" width="480" style="display: block; margin: auto;"></div>
</div>
<div id="simulating-spectra" class="section level3" number="2.1.3">
<h3>
<span class="header-section-number">2.1.3</span> Simulating spectra<a class="anchor" aria-label="anchor" href="#simulating-spectra"><i class="fas fa-link"></i></a>
</h3>
<p>In version 2.9.0 of <code>pavo</code> we also introduced the function <code><a href="http://pavo.colrverse.com/reference/simulate_spec.html">simulate_spec()</a></code>, which allows for the simple and flexible simulation of naturalistic spectra. The arguments allows us to specify sigmoidal (s-shaped) and/or Gaussian (bell-shaped) features, which can be combined as we like to simulate a suite of biological processes.</p>
<p>For example, we might simulate a spectrum with a single Gaussian peak at 500 nm, which might be seen as in various structural colours, or even the absorbance of visual pigments.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spec_gauss</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://pavo.colrverse.com/reference/simulate_spec.html">simulate_spec</a></span><span class="op">(</span>wl_peak <span class="op">=</span> <span class="fl">400</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">spec_gauss</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="colsci-book_files/figure-html/unnamed-chunk-13-1.png" width="576" style="display: block; margin: auto;"></div>
<p>Or a more complex example could include a single sigmoidal peak, with multiple Gaussian peaks, in the one spectrum.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spec_multi</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://pavo.colrverse.com/reference/simulate_spec.html">simulate_spec</a></span><span class="op">(</span>wl_inflect <span class="op">=</span> <span class="fl">575</span>, wl_peak <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">340</span>, <span class="fl">430</span><span class="op">)</span>, width_gauss <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">60</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">spec_multi</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="colsci-book_files/figure-html/unnamed-chunk-14-1.png" width="576" style="display: block; margin: auto;"></div>
<p>Finally, we might simulate a set of Gaussian reflectance curves with peaks varying between 400-600 nm. Such an approach could be useful for various simulation-based studies which seek, for example, to explore optimal receptor sets, or the constraints on colour signal production and perception.</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">peaks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">400</span>, <span class="fl">600</span>, <span class="fl">10</span><span class="op">)</span> <span class="co"># Peak locations</span></span>
<span><span class="va">specs_varying</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">peaks</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="http://pavo.colrverse.com/reference/simulate_spec.html">simulate_spec</a></span><span class="op">(</span>wl_peak <span class="op">=</span> <span class="va">peaks</span><span class="op">[</span><span class="va">x</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="co"># Simulate spectra</span></span>
<span><span class="va">specs_varying</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/funprog.html">Reduce</a></span><span class="op">(</span><span class="va">merge</span>, <span class="va">specs_varying</span><span class="op">)</span> <span class="co"># Combine</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">specs_varying</span><span class="op">)</span> <span class="co"># Plot</span></span></code></pre></div>
<div class="inline-figure"><img src="colsci-book_files/figure-html/unnamed-chunk-15-1.png" width="576" style="display: block; margin: auto;"></div>
</div>
<div id="subsetting-and-merging-spectral-data" class="section level3" number="2.1.4">
<h3>
<span class="header-section-number">2.1.4</span> Subsetting and Merging Spectral Data<a class="anchor" aria-label="anchor" href="#subsetting-and-merging-spectral-data"><i class="fas fa-link"></i></a>
</h3>
<p>Once an <code>rspec</code> object has been created, either by importing raw spectral data, converting a dataset with the <code><a href="http://pavo.colrverse.com/reference/as.rspec.html">as.rspec()</a></code> function, or simulation, you can subset the spectra based on their names using a modified version of <code>R</code>’s built-in <code>subset</code> function. For example, the following code illustrates how to create an <code>rspec</code> object containing only tanagers:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">specs.tanager1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="va">specs</span>, <span class="st">"tanager"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">specs.tanager1</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span></code></pre></div>
<pre><code>#&gt;    wl tanager.0001 tanager.0002 tanager.0003 tanager.0004
#&gt; 1 300      10.0618      10.6744      10.1499      13.7473
#&gt; 2 301      11.1472      10.8054       9.8003      14.3102
#&gt; 3 302      10.7819      10.6134       9.5607      14.4463
#&gt; 4 303      11.0210      11.2037      10.4107      15.5533
#&gt; 5 304      10.2177      11.2120       9.9452      14.3841
#&gt; 6 305      11.5664      11.6135      10.8659      15.6445</code></pre>
<p>The <code>subset</code> function here is using partial matching to find all spectra with the string “tanager” in their name. To fully benefit from this flexible subsetting functionality, it is important that you follow a consistent file naming scheme. For example, <code>tanager.14423.belly.001.ttt</code> would indicate the species (tanager), individual ID (14423), body patch (belly) and measurement number (001). Additionally, we suggest that labels used should have the same number of characters, which simplifies character string manipulation and subsetting based on partial matching.</p>
<p>If you prefer not to use partial matching, <code>subset</code> will also work if you provide a logical condition, similar to the default <code>subset</code> behaviour in <code>R</code>. For example:</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># extract first component of filenames containing species names</span></span>
<span><span class="va">spp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/strsplit.html">strsplit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">specs</span><span class="op">)</span>, <span class="st">"\\."</span><span class="op">)</span><span class="op">)</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># subset</span></span>
<span><span class="va">specs.tanager2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="va">specs</span>, subset <span class="op">=</span> <span class="va">spp</span> <span class="op">==</span> <span class="st">"tanager"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># compare subsetting methods</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html">all.equal</a></span><span class="op">(</span><span class="va">specs.tanager1</span>, <span class="va">specs.tanager2</span><span class="op">)</span></span></code></pre></div>
<pre><code>#&gt; [1] TRUE</code></pre>
<p>Note that <code>subset</code> will also work with visual model (class <code>vismodel</code>) and colspace (class <code>colspace</code>) objects, as described below.</p>
<p>Another useful function is <code>merge</code>. Let’s say that you have subsetted spectra for tanagers and parakeets, and you would like to re-combine them for an analysis. The following lines of code show how to do this:</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">specs.tanager</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="va">specs</span>, <span class="st">"tanager"</span><span class="op">)</span></span>
<span><span class="va">specs.parakeet</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="va">specs</span>, <span class="st">"parakeet"</span><span class="op">)</span></span>
<span><span class="va">specs.new</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html">merge</a></span><span class="op">(</span><span class="va">specs.tanager</span>, <span class="va">specs.parakeet</span><span class="op">)</span></span></code></pre></div>
<p>Note that this re-combined file (<code>specs.new</code>) has only a single <code>wl</code> column with the merged spectra as columns. Keep in mind that the order of objects in <code>merge</code> will determine the order of columns in the final merged object (i.e. tanagers will be before parakeets).</p>
</div>
</div>
<div id="processing-spectral-data" class="section level2" number="2.2">
<h2>
<span class="header-section-number">2.2</span> Processing Spectral Data<a class="anchor" aria-label="anchor" href="#processing-spectral-data"><i class="fas fa-link"></i></a>
</h2>
<div id="averaging-spectra" class="section level3" number="2.2.1">
<h3>
<span class="header-section-number">2.2.1</span> Averaging Spectra<a class="anchor" aria-label="anchor" href="#averaging-spectra"><i class="fas fa-link"></i></a>
</h3>
<p>As previously described, our data (contained in the <code>specs</code> object) consists of multiple individuals, and each was measured three times, as is common to avoid measurement bias. A good way to visualize the repeatability of our measurements is to plot the spectra of each individual separately. The function <code><a href="http://pavo.colrverse.com/reference/explorespec.html">explorespec()</a></code> provides an easy way of doing so. You may specify the number of spectra to be plotted in the same panel using the argument <code>specreps</code>, and the function will adjust the number of panels per page accordingly. We will exemplify this function using only the 12 cardinal individuals measured:</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 36 spectra plus the first (wl) column</span></span>
<span><span class="fu"><a href="http://pavo.colrverse.com/reference/explorespec.html">explorespec</a></span><span class="op">(</span><span class="va">specs</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">37</span><span class="op">]</span>, by <span class="op">=</span> <span class="fl">3</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:explorespecfig"></span>
<img src="colsci-book_files/figure-html/explorespecfig-1.png" alt="Result from `explorespec`, showing the three measurements for each individual cardinal in separate panels" width="576"><p class="caption">
Figure 2.1: Result from <code>explorespec</code>, showing the three measurements for each individual cardinal in separate panels
</p>
</div>
<p>So our first step would be to take the average of each of these three measurements to obtain average individual spectra to be used in further analyses. This is easily accomplished using the <code><a href="http://pavo.colrverse.com/reference/aggspec.html">aggspec()</a></code> function. The <code>by</code> argument can be either a number (specifying how many specs should be averaged for each new sample) or a vector specifying the identities of the spectra to be combined (see below):</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mspecs</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://pavo.colrverse.com/reference/aggspec.html">aggspec</a></span><span class="op">(</span><span class="va">specs</span>, by <span class="op">=</span> <span class="fl">3</span>, FUN <span class="op">=</span> <span class="va">mean</span><span class="op">)</span></span>
<span><span class="va">mspecs</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span></span></code></pre></div>
<pre><code>#&gt;    wl cardinal cardinal.1 cardinal.2
#&gt; 1 300 7.292933   5.676700   6.387233
#&gt; 2 301 7.759200   5.806700   6.698200
#&gt; 3 302 7.959333   5.858467   6.910500
#&gt; 4 303 7.947133   6.130267   7.357567
#&gt; 5 304 8.218200   6.127933   7.195267</code></pre>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Data now has 71 spectra,</span></span>
<span><span class="co"># one for each individual,</span></span>
<span><span class="co"># and the 'wl' column</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">mspecs</span><span class="op">)</span></span></code></pre></div>
<pre><code>#&gt; [1] 401  72</code></pre>
<p>Now we’ll use the <code><a href="http://pavo.colrverse.com/reference/aggspec.html">aggspec()</a></code> function again, but this time to take the average spectrum for each species. However, each species has a different number of samples, so we can’t use the <code>by</code> argument as before. Instead we will use regular expressions to create a species name
vector by removing the numbers that identify individual spectra:</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># create a vector with species identity names</span></span>
<span><span class="va">spp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"\\.[0-9].*$"</span>, <span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">mspecs</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">spp</span><span class="op">)</span></span></code></pre></div>
<pre><code>#&gt; spp
#&gt; cardinal   jacana   oriole parakeet    robin  tanager 
#&gt;       12        9        9       13       10       18</code></pre>
<p>Instead, we are going to use the <code>spp</code> vector we created to tell the <code><a href="http://pavo.colrverse.com/reference/aggspec.html">aggspec()</a></code> function how to average the spectra in <code>mspecs</code>:</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sppspec</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://pavo.colrverse.com/reference/aggspec.html">aggspec</a></span><span class="op">(</span><span class="va">mspecs</span>, by <span class="op">=</span> <span class="va">spp</span>, FUN <span class="op">=</span> <span class="va">mean</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">sppspec</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="op">]</span>, <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<pre><code>#&gt;    wl cardinal jacana oriole parakeet robin tanager
#&gt; 1 300     7.05   7.33   3.89     7.63  3.98    9.02
#&gt; 2 301     7.25   7.35   3.91     7.75  3.91    9.53
#&gt; 3 302     7.44   7.45   4.13     7.89  4.19    9.41
#&gt; 4 303     7.82   8.09   4.39     8.49  4.51   10.20
#&gt; 5 304     7.84   7.71   4.18     8.66  4.07    9.68</code></pre>
</div>
<div id="normalizing-and-smoothing-spectra" class="section level3" number="2.2.2">
<h3>
<span class="header-section-number">2.2.2</span> Normalizing and Smoothing Spectra<a class="anchor" aria-label="anchor" href="#normalizing-and-smoothing-spectra"><i class="fas fa-link"></i></a>
</h3>
<p>Data obtained from spectrometers often requires further processing before analysis and/or publication. For example, electrical noise can produce unwanted “spikes” in reflectance curves. The <code>pavo</code> function <code><a href="http://pavo.colrverse.com/reference/procspec.html">procspec()</a></code> can handle a variety of processing techniques. For example, the reflectance curve from the parakeet is noisy in the short (300-400 nm) and long (650-700 nm) wavelength ranges (see Figure below, black line). To eliminate this noise, we will use local regression smoothing implemented by the <code><a href="https://rdrr.io/r/stats/scatter.smooth.html">loess.smooth()</a></code> function in <code>R</code>, wrapped in the <code>opt="smooth"</code> argument of <code><a href="http://pavo.colrverse.com/reference/procspec.html">procspec()</a></code>.</p>
<p>But first, let’s use the <code><a href="http://pavo.colrverse.com/reference/plotsmooth.html">plotsmooth()</a></code> function to determine a suitable smoothing parameter (<code>span</code>). This function allows you to set a minimum and maximum smoothing parameter to try and plots the resulting curves against the unsmoothed (raw) data in a convenient multipanel figure.</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="http://pavo.colrverse.com/reference/plotsmooth.html">plotsmooth</a></span><span class="op">(</span><span class="va">sppspec</span>,</span>
<span>  minsmooth <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>  maxsmooth <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>  curves <span class="op">=</span> <span class="fl">4</span>,</span>
<span>  ask <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="colsci-book_files/figure-html/unnamed-chunk-21-1.png" width="576" style="display: block; margin: auto;"></div>
<p>From the resulting plot, we can see that <code>span = 0.2</code> is the minimum amount of smoothing to remove spectral noise while preserving the original spectral shape. Based on this value, we will now use the <code>opt</code> argument in <code><a href="http://pavo.colrverse.com/reference/procspec.html">procspec()</a></code> to smooth data for further plotting and analysis.</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spec.sm</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://pavo.colrverse.com/reference/procspec.html">procspec</a></span><span class="op">(</span><span class="va">sppspec</span>, opt <span class="op">=</span> <span class="st">"smooth"</span>, span <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span></code></pre></div>
<pre class="cm"><code>#&gt; processing options applied:
#&gt; smoothing spectra with a span of 0.2</code></pre>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">sppspec</span><span class="op">[</span>, <span class="fl">5</span><span class="op">]</span> <span class="op">~</span> <span class="va">sppspec</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"l"</span>, lwd <span class="op">=</span> <span class="fl">10</span>, col <span class="op">=</span> <span class="st">"grey"</span>,</span>
<span>  xlab <span class="op">=</span> <span class="st">"Wavelength (nm)"</span>, ylab <span class="op">=</span> <span class="st">"Reflectance (%)"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="va">spec.sm</span><span class="op">[</span>, <span class="fl">5</span><span class="op">]</span> <span class="op">~</span> <span class="va">sppspec</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, col <span class="op">=</span> <span class="st">"red"</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-22"></span>
<img src="colsci-book_files/figure-html/unnamed-chunk-22-1.png" alt="Result for raw (grey line) and smoothed (red line) reflectance data for the parakeet" width="480"><p class="caption">
Figure 2.2: Result for raw (grey line) and smoothed (red line) reflectance data for the parakeet
</p>
</div>
<p>We can also try different normalisations. Options include subtracting the minimum reflectance of a spectrum at all wavelengths (effectively making the minimum reflectance equal to zero, <code>opt = "min"</code>, left panel, below) and making the reflectance at all wavelength proportional to the maximum reflectance (i.e. setting maximum reflectance to 1; <code>opt = "max"</code>, centre panel, below). Note that the user can specify multiple processing options that will be applied sequentially to the spectral data by <code><a href="http://pavo.colrverse.com/reference/procspec.html">procspec()</a></code> (right panel, below).</p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Run some different normalisations</span></span>
<span><span class="va">specs.max</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://pavo.colrverse.com/reference/procspec.html">procspec</a></span><span class="op">(</span><span class="va">sppspec</span>, opt <span class="op">=</span> <span class="st">"max"</span><span class="op">)</span></span></code></pre></div>
<pre class="cm"><code>#&gt; processing options applied:
#&gt; Scaling spectra to a maximum value of 1</code></pre>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">specs.min</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://pavo.colrverse.com/reference/procspec.html">procspec</a></span><span class="op">(</span><span class="va">sppspec</span>, opt <span class="op">=</span> <span class="st">"min"</span><span class="op">)</span></span></code></pre></div>
<pre class="cm"><code>#&gt; processing options applied:
#&gt; Scaling spectra to a minimum value of zero</code></pre>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">specs.str</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://pavo.colrverse.com/reference/procspec.html">procspec</a></span><span class="op">(</span><span class="va">sppspec</span>, opt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"min"</span>, <span class="st">"max"</span><span class="op">)</span><span class="op">)</span> <span class="co"># multiple options</span></span></code></pre></div>
<pre class="cm"><code>#&gt; processing options applied:
#&gt; Scaling spectra to a minimum value of zero
#&gt; Scaling spectra to a maximum value of 1</code></pre>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plot results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">specs.min</span><span class="op">[</span>, <span class="fl">5</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">300</span><span class="op">:</span><span class="fl">700</span><span class="op">)</span>,</span>
<span>  xlab <span class="op">=</span> <span class="st">""</span>,</span>
<span>  ylab <span class="op">=</span> <span class="st">""</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"l"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="fl">0</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">specs.max</span><span class="op">[</span>, <span class="fl">5</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">300</span><span class="op">:</span><span class="fl">700</span><span class="op">)</span>,</span>
<span>  ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  xlab <span class="op">=</span> <span class="st">""</span>,</span>
<span>  ylab <span class="op">=</span> <span class="st">""</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"l"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">specs.str</span><span class="op">[</span>, <span class="fl">5</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">300</span><span class="op">:</span><span class="fl">700</span><span class="op">)</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"l"</span>,</span>
<span>  xlab <span class="op">=</span> <span class="st">""</span>,</span>
<span>  ylab <span class="op">=</span> <span class="st">""</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/mtext.html">mtext</a></span><span class="op">(</span><span class="st">"Wavelength (nm)"</span>, side <span class="op">=</span> <span class="fl">1</span>, outer <span class="op">=</span> <span class="cn">TRUE</span>, line <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/mtext.html">mtext</a></span><span class="op">(</span><span class="st">"Normalised reflectance (%)"</span>, side <span class="op">=</span> <span class="fl">2</span>, outer <span class="op">=</span> <span class="cn">TRUE</span>, line <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-24"></span>
<img src="colsci-book_files/figure-html/unnamed-chunk-24-1.png" alt="Results for min (left), max (centre), and both normalisations (right)" width="50%"><img src="colsci-book_files/figure-html/unnamed-chunk-24-2.png" alt="Results for min (left), max (centre), and both normalisations (right)" width="50%"><img src="colsci-book_files/figure-html/unnamed-chunk-24-3.png" alt="Results for min (left), max (centre), and both normalisations (right)" width="50%"><p class="caption">
Figure 2.3: Results for min (left), max (centre), and both normalisations (right)
</p>
</div>
</div>
<div id="binning-and-pca-analysis-of-spectral-shape" class="section level3" number="2.2.3">
<h3>
<span class="header-section-number">2.2.3</span> Binning and PCA Analysis of Spectral Shape<a class="anchor" aria-label="anchor" href="#binning-and-pca-analysis-of-spectral-shape"><i class="fas fa-link"></i></a>
</h3>
<p>Another intended usage of <code><a href="http://pavo.colrverse.com/reference/procspec.html">procspec()</a></code> is preparation of spectral data for dimensionality reduction (for example, using Principal Component Analysis, or PCA). Following <span class="citation">Cuthill et al. (<a href="references.html#ref-Cuthill1999">1999</a>)</span>, we can use <code>opt = 'center'</code> to centre spectra to have a mean reflectance of zero (thus removing brightness as a dominant variable in the PCA) and then bin the spectra into user-defined bins (using the <code>opt = 'bin'</code> argument) to obtain a dataframe suitable for the PCA.</p>
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># PCA analysis</span></span>
<span><span class="va">spec.bin</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://pavo.colrverse.com/reference/procspec.html">procspec</a></span><span class="op">(</span><span class="va">sppspec</span>, opt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"bin"</span>, <span class="st">"center"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre class="cm"><code>#&gt; processing options applied:
#&gt; Centering spectra to a mean of zero
#&gt; binned spectra to 21-nm intervals</code></pre>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">spec.bin</span><span class="op">)</span></span></code></pre></div>
<pre><code>#&gt;    wl   cardinal    jacana    oriole  parakeet      robin
#&gt; 1 300 -12.991747 -15.98282 -17.78389 -5.187601 -10.043001
#&gt; 2 321  -8.754302 -15.22013 -15.67409 -3.497942  -9.751455
#&gt; 3 342  -5.490538 -14.60414 -14.58129 -3.695973  -9.454188
#&gt; 4 363  -4.639077 -14.17163 -15.03655 -5.552378  -9.222658
#&gt; 5 384  -5.563199 -14.48320 -16.68218 -7.387742  -8.880768
#&gt; 6 405  -8.639736 -14.92472 -17.86635 -8.574752  -8.326391
#&gt;       tanager
#&gt; 1 -9.61852071
#&gt; 2 -6.74685034
#&gt; 3 -2.77517997
#&gt; 4 -0.14415405
#&gt; 5 -0.03173553
#&gt; 6 -1.44428182</code></pre>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Transpose so wavelength are variables for the PCA</span></span>
<span><span class="va">spec.bin</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">spec.bin</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Names variables as wavelength bins</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">spec.bin</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">spec.bin</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span></span>
<span><span class="va">spec.bin</span> <span class="op">&lt;-</span> <span class="va">spec.bin</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span>, <span class="op">]</span> <span class="co"># remove 'wl' column</span></span>
<span><span class="va">pca1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/prcomp.html">prcomp</a></span><span class="op">(</span><span class="va">spec.bin</span>, scale. <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">pca1</span><span class="op">)</span></span></code></pre></div>
<pre><code>#&gt; Importance of components:
#&gt;                           PC1    PC2    PC3    PC4     PC5
#&gt; Standard deviation     3.6016 1.9885 1.5791 0.6678 0.36656
#&gt; Proportion of Variance 0.6486 0.1977 0.1247 0.0223 0.00672
#&gt; Cumulative Proportion  0.6486 0.8463 0.9710 0.9933 1.00000
#&gt;                              PC6
#&gt; Standard deviation     4.411e-16
#&gt; Proportion of Variance 0.000e+00
#&gt; Cumulative Proportion  1.000e+00</code></pre>
<p>As can be seen by the summary, PC1 explains approximately 64% of the variation in spectral shape and describes the ratio of short to long wavelengths reflected. The flexibility of <code>R</code> and <code>pavo</code>’s plotting capabilities allows you to sort spectra by another variable (e.g., PC1 loading) and then plot in a stacked format using the <code>plot</code> function.</p>
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Generate colours from spectra</span></span>
<span><span class="va">colr</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://pavo.colrverse.com/reference/spec2rgb.html">spec2rgb</a></span><span class="op">(</span><span class="va">sppspec</span><span class="op">)</span></span>
<span><span class="va">wls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">spec.bin</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Rank specs by PC1</span></span>
<span><span class="va">sel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rank.html">rank</a></span><span class="op">(</span><span class="va">pca1</span><span class="op">$</span><span class="va">x</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">sel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/match.html">match</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="va">sel</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">sppspec</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">pca1</span><span class="op">$</span><span class="va">rotation</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">~</span> <span class="va">wls</span>, type <span class="op">=</span> <span class="st">"l"</span>, ylab <span class="op">=</span> <span class="st">"PC1 loading"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="fl">0</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">sppspec</span>,</span>
<span>  select <span class="op">=</span> <span class="va">sel</span>,</span>
<span>  labels.stack <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">sppspec</span><span class="op">)</span><span class="op">[</span><span class="va">sel</span><span class="op">]</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"s"</span>,</span>
<span>  col <span class="op">=</span> <span class="va">colr</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/mtext.html">mtext</a></span><span class="op">(</span><span class="st">"Wavelength (nm)"</span>, side <span class="op">=</span> <span class="fl">1</span>, outer <span class="op">=</span> <span class="cn">TRUE</span>, line <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-27"></span>
<img src="colsci-book_files/figure-html/unnamed-chunk-27-1.png" alt="Plot of PC1 loading versus wavelength (left) and species mean spectra sorted vertically from lowest to highest PC1 value (right; values on right hand axis are column identities)." width="45%"><img src="colsci-book_files/figure-html/unnamed-chunk-27-2.png" alt="Plot of PC1 loading versus wavelength (left) and species mean spectra sorted vertically from lowest to highest PC1 value (right; values on right hand axis are column identities)." width="45%"><p class="caption">
Figure 2.4: Plot of PC1 loading versus wavelength (left) and species mean spectra sorted vertically from lowest to highest PC1 value (right; values on right hand axis are column identities).
</p>
</div>
</div>
<div id="dealing-with-negative-values-in-spectra" class="section level3" number="2.2.4">
<h3>
<span class="header-section-number">2.2.4</span> Dealing With Negative Values in Spectra<a class="anchor" aria-label="anchor" href="#dealing-with-negative-values-in-spectra"><i class="fas fa-link"></i></a>
</h3>
<p>Negative values in spectra are unwanted, as they are uninterpretable (how can there be less than zero light reflected by a surface?) and can affect estimates of colour variables. Nonetheless, certain spectrometer manufacturers allow negative values to be saved. To handle negative values, the <code><a href="http://pavo.colrverse.com/reference/procspec.html">procspec()</a></code> function has an argument called <code>fixneg</code>. The two options available are (1) adding the absolute value of the most negative value to the whole spectrum with <code>addmin</code>, and (2) changing all negative values to zero with <code>zero</code>.</p>
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create a duplicate spectrum and add some negative values</span></span>
<span><span class="va">refl</span> <span class="op">&lt;-</span> <span class="va">sppspec</span><span class="op">[</span>, <span class="fl">7</span><span class="op">]</span> <span class="op">-</span> <span class="fl">20</span></span>
<span><span class="va">testspecs</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://pavo.colrverse.com/reference/as.rspec.html">as.rspec</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">300</span><span class="op">:</span><span class="fl">700</span><span class="op">)</span>, <span class="va">refl</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre class="cm"><code>#&gt; wavelengths found in column 1</code></pre>
<pre class="cm"><code>#&gt; The spectral data contain 188 negative value(s),
#&gt;  which may produce unexpected results if used in models.
#&gt; Consider using procspec() to correct them.</code></pre>
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Apply two different processing options</span></span>
<span><span class="va">testspecs.fix1</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://pavo.colrverse.com/reference/procspec.html">procspec</a></span><span class="op">(</span><span class="va">testspecs</span>, fixneg <span class="op">=</span> <span class="st">"addmin"</span><span class="op">)</span></span></code></pre></div>
<pre class="cm"><code>#&gt; processing options applied:
#&gt; Negative value correction: added min to all reflectance</code></pre>
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">testspecs.fix2</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://pavo.colrverse.com/reference/procspec.html">procspec</a></span><span class="op">(</span><span class="va">testspecs</span>, fixneg <span class="op">=</span> <span class="st">"zero"</span><span class="op">)</span></span></code></pre></div>
<pre class="cm"><code>#&gt; processing options applied:
#&gt; Negative value correction: converted negative values to zero</code></pre>
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plot it</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">testspecs</span>, select <span class="op">=</span> <span class="fl">2</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">10</span>, <span class="fl">30</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="fl">0</span>, lty <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">testspecs.fix1</span>, select <span class="op">=</span> <span class="fl">2</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">10</span>, <span class="fl">30</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="fl">0</span>, lty <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">testspecs.fix2</span>, select <span class="op">=</span> <span class="fl">2</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">10</span>, <span class="fl">30</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="fl">0</span>, lty <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/mtext.html">mtext</a></span><span class="op">(</span><span class="st">"Wavelength (nm)"</span>, side <span class="op">=</span> <span class="fl">1</span>, outer <span class="op">=</span> <span class="cn">TRUE</span>, line <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/mtext.html">mtext</a></span><span class="op">(</span><span class="st">"Reflectance (%)"</span>, side <span class="op">=</span> <span class="fl">2</span>, outer <span class="op">=</span> <span class="cn">TRUE</span>, line <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-29"></span>
<img src="colsci-book_files/figure-html/unnamed-chunk-29-1.png" alt="Plots showing original reflectance curve including negative values (left) and two processed curves using `fixneg = addmin` (center) and `fixneg = zero` (right)." width="50%"><img src="colsci-book_files/figure-html/unnamed-chunk-29-2.png" alt="Plots showing original reflectance curve including negative values (left) and two processed curves using `fixneg = addmin` (center) and `fixneg = zero` (right)." width="50%"><img src="colsci-book_files/figure-html/unnamed-chunk-29-3.png" alt="Plots showing original reflectance curve including negative values (left) and two processed curves using `fixneg = addmin` (center) and `fixneg = zero` (right)." width="50%"><p class="caption">
Figure 2.5: Plots showing original reflectance curve including negative values (left) and two processed curves using <code>fixneg = addmin</code> (center) and <code>fixneg = zero</code> (right).
</p>
</div>
<p>These manipultions may have different effects on the final spectra, which the user should keep in mind and use according to the final goal of the analysis. For example, by adding the minimum reflectance to all other wavelength, the shape of the curve is preserved, but the maximum reflectance is much higher. On the other hand, substituting negative values with zero preserves absolute reflectance values, but may cause the spectral shape to be lost. The “best” transformation will depend on the severity of the problem of negative values and the goal of the analysis (e.g. will reflectance intensity be used? What is more important, to preserve reflectance values or the total shape of the curve?). Which correction to use would also depend on the source of the negative values. If they are thought to originate from improper calibration of the spectrophotometer, <code>fixneg = addmin</code> would be appropriate. However, if they are thought to originate from electric noise, <code>fixneg = zero</code> would be more appropriate.</p>
</div>
</div>
<div id="visualizing-spectral-data" class="section level2" number="2.3">
<h2>
<span class="header-section-number">2.3</span> Visualizing Spectral Data<a class="anchor" aria-label="anchor" href="#visualizing-spectral-data"><i class="fas fa-link"></i></a>
</h2>
<p><code>pavo</code> offers three main plotting functions. The main one is <code>plot</code>, which combines several different options in a flexible framework for most commonly used purposes. The <code><a href="http://pavo.colrverse.com/reference/explorespec.html">explorespec()</a></code> function aims at providing initial exploratory analysis, as demonstrated in Section 1. Finally, <code><a href="http://pavo.colrverse.com/reference/aggplot.html">aggplot()</a></code> provides a simple framework for publication-quality plots of aggregated spectral data.</p>
<div id="the-plot-function-options" class="section level3" number="2.3.1">
<h3>
<span class="header-section-number">2.3.1</span> The <code>plot</code> Function Options<a class="anchor" aria-label="anchor" href="#the-plot-function-options"><i class="fas fa-link"></i></a>
</h3>
<p>Since <code>pavo</code> uses the class <code>rspec</code> to identify spectral data, the function <code>plot.rspec()</code> can be called simply by calling <code>plot(data)</code>. If the object is not of class <code>rspec</code> the multivariate visualisation methods will not work as expected, so it might be useful to check the data using <code><a href="http://pavo.colrverse.com/reference/as.rspec.html">is.rspec()</a></code> and convert with <code><a href="http://pavo.colrverse.com/reference/as.rspec.html">as.rspec()</a></code> if necessary.</p>
<p>We have implemented three methods of visualizing spectral data using <code>plot</code>:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Overlay</strong>: all spectra plotted with same x- and y-axis</li>
<li>
<strong>Stack</strong>: spectra plotted with same x-axis but arranged vertically along y-axis</li>
<li>
<strong>Heatmap</strong>: false colour map to illustrate three dimensional data</li>
</ol>
<p>These options are in addition to the exploratory plotting offered by <code><a href="http://pavo.colrverse.com/reference/explorespec.html">explorespec()</a></code>, as seen in the figures in section 1. To showcase the capabilities of <code>plot.rspec()</code>, we will use the <code>teal</code> dataset included in <code>pavo</code>. This dataset consists of reflectance spectra from the iridescent wing patch of a green-winged teal (<em>Anas carolinensis</em>). Reflectance measurements were taken between 300 and 700 nm at different incident angles, ranging from 15° to 70° (in 5° increments) <span class="citation">(<a href="references.html#ref-Eliason2012">Eliason and Shawkey 2012</a>)</span>.</p>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-30"></span>
<img src="fig/anas-carolinensis.jpg" alt="Anas carolinensis, by pixabay user Cock-Robin, CC0" width="100%"><p class="caption">
Figure 2.6: Anas carolinensis, by pixabay user Cock-Robin, CC0
</p>
</div>
<div id="the-overlay-option" class="section level4" number="2.3.1.1">
<h4>
<span class="header-section-number">2.3.1.1</span> The <code>overlay</code> Option<a class="anchor" aria-label="anchor" href="#the-overlay-option"><i class="fas fa-link"></i></a>
</h4>
<p>We can start out by visualizing these spectra with the <code>overlay</code> option in plot. Another neat option <code>pavo</code> offers is to convert reflectance spectra to their approximate perceived colour, by using the function <code><a href="http://pavo.colrverse.com/reference/spec2rgb.html">spec2rgb()</a></code>. This can make for some very interesting plots and even exploratory data analysis, as shown above.</p>
<div class="sourceCode" id="cb79"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">teal</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">teal</span>, type <span class="op">=</span> <span class="st">"o"</span>, col <span class="op">=</span> <span class="fu"><a href="http://pavo.colrverse.com/reference/spec2rgb.html">spec2rgb</a></span><span class="op">(</span><span class="va">teal</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-31"></span>
<img src="colsci-book_files/figure-html/unnamed-chunk-31-1.png" alt="Overlay plot of the teal angle-dependent reflectance with colours of each curve being an approximation of the perceived colour." width="480"><p class="caption">
Figure 2.7: Overlay plot of the teal angle-dependent reflectance with colours of each curve being an approximation of the perceived colour.
</p>
</div>
</div>
<div id="the-stack-option" class="section level4" number="2.3.1.2">
<h4>
<span class="header-section-number">2.3.1.2</span> The <code>stack</code> Option<a class="anchor" aria-label="anchor" href="#the-stack-option"><i class="fas fa-link"></i></a>
</h4>
<p>Another option is the <code>stack</code> plot (again, with human vision approximations of the colour produced by the spectra using <code><a href="http://pavo.colrverse.com/reference/spec2rgb.html">spec2rgb()</a></code>).</p>
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">teal.norm</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://pavo.colrverse.com/reference/procspec.html">procspec</a></span><span class="op">(</span><span class="va">teal</span>, opt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"min"</span>, <span class="st">"max"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre class="cm"><code>#&gt; processing options applied:
#&gt; Scaling spectra to a minimum value of zero
#&gt; Scaling spectra to a maximum value of 1</code></pre>
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">teal</span>, type <span class="op">=</span> <span class="st">"s"</span>, col <span class="op">=</span> <span class="fu"><a href="http://pavo.colrverse.com/reference/spec2rgb.html">spec2rgb</a></span><span class="op">(</span><span class="va">teal</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">teal.norm</span>, type <span class="op">=</span> <span class="st">"s"</span>, col <span class="op">=</span> <span class="fu"><a href="http://pavo.colrverse.com/reference/spec2rgb.html">spec2rgb</a></span><span class="op">(</span><span class="va">teal</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/mtext.html">mtext</a></span><span class="op">(</span><span class="st">"Wavelength (nm)"</span>, side <span class="op">=</span> <span class="fl">1</span>, outer <span class="op">=</span> <span class="cn">TRUE</span>, line <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/mtext.html">mtext</a></span><span class="op">(</span><span class="st">"Cumulative reflectance (A.U.)"</span>, side <span class="op">=</span> <span class="fl">2</span>, outer <span class="op">=</span> <span class="cn">TRUE</span>, line <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-32"></span>
<img src="colsci-book_files/figure-html/unnamed-chunk-32-1.png" alt="Stacked plot of the raw (left) and normalized (right) teal angle-dependent reflectance" width="45%"><img src="colsci-book_files/figure-html/unnamed-chunk-32-2.png" alt="Stacked plot of the raw (left) and normalized (right) teal angle-dependent reflectance" width="45%"><p class="caption">
Figure 2.8: Stacked plot of the raw (left) and normalized (right) teal angle-dependent reflectance
</p>
</div>
<p>Note that in the above figure, the y axis to the right includes the index of each spectrum. This makes it easier to identify and subset specific spectra or groups of spectra using the <code>select</code> argument in <code>plot.rspec()</code>. Note also that the first index is actually 2, preserving the sequence in the original dataset (since the first column is wavelength). Though this may seem confusing at first (“why is my first spec number 2?”) this preserves subsetting hierarchy: using <code>plot(teal, select = 2)</code> will show the same spectra that would be selected if you use <code>teal[ ,2]</code>.</p>
</div>
<div id="the-heatmap-option" class="section level4" number="2.3.1.3">
<h4>
<span class="header-section-number">2.3.1.3</span> The <code>heatmap</code> Option<a class="anchor" aria-label="anchor" href="#the-heatmap-option"><i class="fas fa-link"></i></a>
</h4>
<p>Since this dataset is three-dimensional (containing wavelengths, reflectance values and incident angles) we can also use the <code>heatmap</code> function. First, it will be necessary to define a vector for the incident angles each spectrum was measured at:</p>
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">angles</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">15</span>, <span class="fl">70</span>, by <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span></code></pre></div>
<p>Next, we will smooth the data with <code><a href="http://pavo.colrverse.com/reference/procspec.html">procspec()</a></code> and plot as a false colour map (heatmap):</p>
<div class="sourceCode" id="cb84"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Smooth the spectral data</span></span>
<span><span class="va">teal.sm</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://pavo.colrverse.com/reference/procspec.html">procspec</a></span><span class="op">(</span><span class="va">teal</span>, opt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"smooth"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre class="cm"><code>#&gt; processing options applied:
#&gt; smoothing spectra with a span of 0.25</code></pre>
<div class="sourceCode" id="cb86"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plot it as a heatmap</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">teal.sm</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"h"</span>, varying <span class="op">=</span> <span class="va">angles</span>,</span>
<span>  ylab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Incident angle ("</span>, <span class="va">degree</span>, <span class="st">")"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  las <span class="op">=</span> <span class="fl">1</span>, useRaster <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-34"></span>
<img src="colsci-book_files/figure-html/unnamed-chunk-34-1.png" alt="Heatmap plot for angle-resolved reflectance measurements of the green-winged teal." width="480"><p class="caption">
Figure 2.9: Heatmap plot for angle-resolved reflectance measurements of the green-winged teal.
</p>
</div>
<p>These plots can be very useful to observe changes over time, for example, or any other type of continuous variation.</p>
</div>
</div>
<div id="the-aggplot-function" class="section level3" number="2.3.2">
<h3>
<span class="header-section-number">2.3.2</span> The <code>aggplot()</code> Function<a class="anchor" aria-label="anchor" href="#the-aggplot-function"><i class="fas fa-link"></i></a>
</h3>
<p><code><a href="http://pavo.colrverse.com/reference/aggplot.html">aggplot()</a></code> has a very similar interface to <code><a href="http://pavo.colrverse.com/reference/aggspec.html">aggspec()</a></code>, allowing for quick plotting of aggregated spectra combined by a factor, such as species, sex, experimental treatment, and so on. Its main output is a plot with lines of group mean spectra outlined by a shaded area indicating some measure of variability, such as the standard deviation of the group. Note that functions that aren’t already implemented in R must be passed like they would be to functions such as <code>apply</code> (e.g., <code>function(x) sd(x)/sqrt(length(x))</code> in the example below).</p>
<div class="sourceCode" id="cb87"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plot using median and standard deviation, default colours</span></span>
<span><span class="fu"><a href="http://pavo.colrverse.com/reference/aggplot.html">aggplot</a></span><span class="op">(</span><span class="va">mspecs</span>, <span class="va">spp</span>,</span>
<span>  FUN.center <span class="op">=</span> <span class="va">median</span>,</span>
<span>  ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">70</span><span class="op">)</span>,</span>
<span>  alpha <span class="op">=</span> <span class="fl">0.3</span>, legend <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot using mean and standard error, in greyscale</span></span>
<span><span class="fu"><a href="http://pavo.colrverse.com/reference/aggplot.html">aggplot</a></span><span class="op">(</span><span class="va">mspecs</span>, <span class="va">spp</span>,</span>
<span>  ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">70</span><span class="op">)</span>,</span>
<span>  FUN.error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  lcol <span class="op">=</span> <span class="fl">1</span>, shadecol <span class="op">=</span> <span class="st">"grey"</span>, alpha <span class="op">=</span> <span class="fl">0.7</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-35"></span>
<img src="colsci-book_files/figure-html/unnamed-chunk-35-1.png" alt="Example plots created using `aggplot`. Left: using median, standard deviation, and coloured lines. Right: using mean, standard error, and greyscale" width="45%"><img src="colsci-book_files/figure-html/unnamed-chunk-35-2.png" alt="Example plots created using `aggplot`. Left: using median, standard deviation, and coloured lines. Right: using mean, standard error, and greyscale" width="45%"><p class="caption">
Figure 2.10: Example plots created using <code>aggplot</code>. Left: using median, standard deviation, and coloured lines. Right: using mean, standard error, and greyscale
</p>
</div>
</div>
</div>
<div id="organizing-spatial-image-data" class="section level2" number="2.4">
<h2>
<span class="header-section-number">2.4</span> Organizing Spatial (image) Data<a class="anchor" aria-label="anchor" href="#organizing-spatial-image-data"><i class="fas fa-link"></i></a>
</h2>
<p>We first import our images with <code><a href="http://pavo.colrverse.com/reference/getimg.html">getimg()</a></code>, which functions in a similar manner to <code><a href="http://pavo.colrverse.com/reference/getspec.html">getspec()</a></code>. Since we are importing more than one image, we can simply point the function to the folder containing the images, and it will use parallel processing (where possible) to import any jpg, bmp, or png images in the folder. As with the raw spectra, these images are also available at the package repository [here][data-location], but are included in the package installation for convenience.</p>
<div class="sourceCode" id="cb88"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">butterflies</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://pavo.colrverse.com/reference/getimg.html">getimg</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"testdata/images/butterflies"</span>,</span>
<span>  package <span class="op">=</span> <span class="st">"pavo"</span></span>
<span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre class="cm"><code>#&gt; 2 files found; importing images.</code></pre>
<p>When <code>pavo</code> imports images, it created a multidimensional object of class <code>rimg</code>, which inherits from the <code>array</code> class. If more than one image is imported, then these <code>rimg</code> objects are stored as elements in a list. All image-based functions in <code>pavo</code> are capable of working with such <code>rimg</code> lists, which allows for a more convenient and tidy high-throughput workflow. Note that while <code>pavo</code> will allow you to load, manipulate, and analyse as many images as your computer’s memory allows, it will throw a message if the total size of images in memory is greater than ca. 200mb, as this will result in noticeably slowed performance (everything will still work, it will just be slow). This may be ameliorated by reducing the size of individual images, such as through <code><a href="http://pavo.colrverse.com/reference/procimg.html">procimg()</a></code>, or by processing images in smaller batches. All <code>rimg</code> objects have a number of identifying attributes, drawn on by image-processing functions, which can be readily inspected.</p>
<div class="sourceCode" id="cb90"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="http://pavo.colrverse.com/reference/as.rimg.html">is.rimg</a></span><span class="op">(</span><span class="va">butterflies</span><span class="op">)</span></span></code></pre></div>
<pre><code>#&gt; [1] TRUE</code></pre>
<div class="sourceCode" id="cb92"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">butterflies</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code>#&gt;  'rimg' num [1:500, 1:340, 1:3] 1 1 1 1 1 1 1 1 1 1 ...
#&gt;  - attr(*, "state")= chr "raw"
#&gt;  - attr(*, "imgname")= chr "h_melpomene"
#&gt;  - attr(*, "px_scale")= logi NA
#&gt;  - attr(*, "raw_scale")= logi NA
#&gt;  - attr(*, "k")= logi NA
#&gt;  - attr(*, "outline")= logi NA
#&gt;  - attr(*, "colnames")= logi NA
#&gt;  - attr(*, "tag_loc")= logi NA</code></pre>
<div class="sourceCode" id="cb94"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">butterflies</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code>#&gt;  'rimg' num [1:500, 1:398, 1:3] 1 1 1 1 1 1 1 1 1 1 ...
#&gt;  - attr(*, "state")= chr "raw"
#&gt;  - attr(*, "imgname")= chr "papilio"
#&gt;  - attr(*, "px_scale")= logi NA
#&gt;  - attr(*, "raw_scale")= logi NA
#&gt;  - attr(*, "k")= logi NA
#&gt;  - attr(*, "outline")= logi NA
#&gt;  - attr(*, "colnames")= logi NA
#&gt;  - attr(*, "tag_loc")= logi NA</code></pre>
<p>If you already have images loaded into R, you can convert them to <code>rimg</code> objects using <code><a href="http://pavo.colrverse.com/reference/as.rimg.html">as.rimg()</a></code>. The function will attempt to interpret a multidimensional array as an RGB image with values ranging between [0, 1], and imbue it with the custom attributes of an <code>rimg</code>. We can see this by creating a fake array, before converting it.</p>
<div class="sourceCode" id="cb96"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fakeimg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html">array</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">12</span>, ncol <span class="op">=</span> <span class="fl">8</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">12</span>, ncol <span class="op">=</span> <span class="fl">8</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">12</span>, ncol <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">12</span>, <span class="fl">8</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">fake_rimg</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://pavo.colrverse.com/reference/as.rimg.html">as.rimg</a></span><span class="op">(</span><span class="va">fakeimg</span><span class="op">)</span></span>
<span><span class="fu"><a href="http://pavo.colrverse.com/reference/as.rimg.html">is.rimg</a></span><span class="op">(</span><span class="va">fake_rimg</span><span class="op">)</span></span></code></pre></div>
<pre><code>#&gt; [1] TRUE</code></pre>
<div class="sourceCode" id="cb98"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">fake_rimg</span><span class="op">)</span></span></code></pre></div>
<pre><code>#&gt;  'rimg' num [1:12, 1:8, 1:3] 1 1 0 0 1 1 0 0 1 1 ...
#&gt;  - attr(*, "state")= chr "raw"
#&gt;  - attr(*, "imgname")= chr "img"
#&gt;  - attr(*, "px_scale")= logi NA
#&gt;  - attr(*, "raw_scale")= logi NA
#&gt;  - attr(*, "k")= logi NA
#&gt;  - attr(*, "outline")= logi NA
#&gt;  - attr(*, "colnames")= logi NA
#&gt;  - attr(*, "tag_loc")= logi NA</code></pre>
</div>
<div id="visualising-image-data" class="section level2" number="2.5">
<h2>
<span class="header-section-number">2.5</span> Visualising Image Data<a class="anchor" aria-label="anchor" href="#visualising-image-data"><i class="fas fa-link"></i></a>
</h2>
<div id="the-plot-and-summary-functions" class="section level3" number="2.5.1">
<h3>
<span class="header-section-number">2.5.1</span> The <code>plot</code> and <code>summary</code> Functions<a class="anchor" aria-label="anchor" href="#the-plot-and-summary-functions"><i class="fas fa-link"></i></a>
</h3>
<p>Thanks to the underlying class system of <code>pavo</code>, the generic functions <code>plot</code> and <code>summary</code> recognise and respond to image-data in an appropriate manner, as is the case with spectral data. A quick call to <code>plot</code>, for example, prints our images. Note that while we call an image individually below (for convenient printing in the vignette), we could simply feed the entire list of images to <code>plot</code> and it would automatically step through each image in the list upon user input.</p>
<div class="sourceCode" id="cb100"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Note the plot titles are taken</span></span>
<span><span class="co"># from the file names, and can be overridden.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">butterflies</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">butterflies</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-39"></span>
<img src="colsci-book_files/figure-html/unnamed-chunk-39-1.png" alt="Raw images of our butterflies" width="100%"><p class="caption">
Figure 2.11: Raw images of our butterflies
</p>
</div>
<p>The <code>summary</code> function offers some summary information about images or lists of images as we might expect. If we specify <code>plot = TRUE</code> however, the function instead plots the image. When such images have been colour-classified this also plots the images’ colour palette alongside (see below). This is an extremely useful diagnostic tool when classifying images, as it allows us to see how well the classification algorithm has performed in clustering colour pattern elements into discrete colour categories. As with all plots, the function takes all standard plot arguments (see <code><a href="https://rdrr.io/r/graphics/par.html">?par</a></code>), such as custom colours, which again can be diagnostically useful.</p>
</div>
</div>
<div id="processing-image-data" class="section level2" number="2.6">
<h2>
<span class="header-section-number">2.6</span> Processing Image Data<a class="anchor" aria-label="anchor" href="#processing-image-data"><i class="fas fa-link"></i></a>
</h2>
<div id="overview" class="section level3" number="2.6.1">
<h3>
<span class="header-section-number">2.6.1</span> Overview<a class="anchor" aria-label="anchor" href="#overview"><i class="fas fa-link"></i></a>
</h3>
<p>Images often require some post-capture processing, depending on the intended use, and <code>pavo</code> offers some useful options via <code><a href="http://pavo.colrverse.com/reference/procimg.html">procimg()</a></code>. The functionality of <code><a href="http://pavo.colrverse.com/reference/procimg.html">procimg()</a></code> is currently limited to only that which is closely relevant to the analyses currently implemented, as we assume any major processing and quality-checking (e.g. image rotation and colour correction) is undertaken by the user beforehand. However, should users with to keep their image processing within the R ecosystem, there now exist several excellent image-processing packages such as <code>imager</code> and <code>magick</code>, which <code>pavo</code> can seamlessly work with. Indeed, the functions <code><a href="http://pavo.colrverse.com/reference/img_conversion.html">rimg2cimg()</a></code> and <code><a href="http://pavo.colrverse.com/reference/img_conversion.html">rimg2magick()</a></code> convert images from <code>pavo</code> preferred structure to that used by <code>imager</code> (with the reverse simply achieved via <code><a href="http://pavo.colrverse.com/reference/as.rimg.html">as.rimg()</a></code>), which simplifies the transitions between these packages.</p>
</div>
<div id="filtering-images-to-model-the-visual-acuity-of-animals" class="section level3" number="2.6.2">
<h3>
<span class="header-section-number">2.6.2</span> Filtering images to model the visual acuity of animals<a class="anchor" aria-label="anchor" href="#filtering-images-to-model-the-visual-acuity-of-animals"><i class="fas fa-link"></i></a>
</h3>
<p>The resolving power of animals is in large part defined by their visual acuity, and this reality has has important consequences for questions of signal evolution and visual ecology. This process can can now be accounted for (in part) via <code><a href="http://pavo.colrverse.com/reference/procimg.html">procimg()</a></code> which implements the AcuityView algorithm of Caves and Johnson (2018). Note that for users familiar with the algorithm this is the 2.0 implementation, which now accepts any rectangular images (not only those which are square with dimensions a power of 2).</p>
<p>To run the procedure, <code><a href="http://pavo.colrverse.com/reference/procimg.html">procimg()</a></code> requires three arguments: <code>obj_dist</code>, the real-world distance between the viewer and the focal object in the image, <code>obj_width</code>, the real-world width of the entire image, and <code>eye_res</code>, the resolution of the viewer in degrees. Any units of measurement are suitable for <code>obj_dist</code> and <code>obj_width</code>, but they must match. Here we’ll run our butterfly images through the process assuming a conspecific viewer at a distance of 60 cm, an image width of 10 cm, and visual acuity 0.2 CPD.</p>
<div class="sourceCode" id="cb101"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Model the appearance of our butterflies given the reduced</span></span>
<span><span class="co"># visual acuity of another animal viewer as per the</span></span>
<span><span class="co"># AcuityView 2.0 algorithm (Caves &amp; Johnsen 2018). Here</span></span>
<span><span class="co"># our butterfly is 60 cm away, the image width is 10 cm,</span></span>
<span><span class="co"># and the spatial resolution of the viewer is 0.2-degrees.</span></span>
<span><span class="va">butterflies_acuity</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://pavo.colrverse.com/reference/procimg.html">procimg</a></span><span class="op">(</span><span class="va">butterflies</span>,</span>
<span>  obj_dist <span class="op">=</span> <span class="fl">60</span>,</span>
<span>  obj_width <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  eye_res <span class="op">=</span> <span class="fl">0.2</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># See the results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">butterflies_acuity</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">butterflies_acuity</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-40"></span>
<img src="colsci-book_files/figure-html/unnamed-chunk-40-1.png" alt="Images of our butterflies after modelling for the acuity of a conspecific viewer" width="100%"><p class="caption">
Figure 2.12: Images of our butterflies after modelling for the acuity of a conspecific viewer
</p>
</div>
<p>Note there are some important considerations and caveats to the method. The core publication of <span class="citation">Caves and Johnsen (<a href="references.html#ref-caves2018acuityview">2018</a>)</span> provides rich discussion of these points (and should of course also be cited whenever used). In brief, however, it should be remembered that:</p>
<ol style="list-style-type: decimal">
<li>While AcuityView allows us to gain insight into what spatial information can and cannot be detected by a viewer, the converted image is not what the animal actually sees. No experimental or theoretical treatment can provide much insight into the perceptual world of another animal.</li>
<li>The converted image does not account for edge enhancement and other processing by the retina and brain that that can sharpen (but not add detail) to an image. The converted image is also static, which does not allow one to assess how movement may reveal the presence of an otherwise indiscernible object.</li>
<li>The AcuityView algorithm makes several assumptions about the modulation transfer function (MTF). First, it assumes that the MTF is constant over the region of the eye that views the scene, and that the scene of interest is viewed by the portion of the retina with the highest acuity (e.g. fovea). It also assumes that the MTF is circularly symmetrical, which is not always true. Some eyes have non-circular PSFs which can lead to non-circular MTFs (e.g. Baldwin Fergus et al., 2015). Finally, it assumes that the MTF is wavelength-independent, whereas an MTF which is strongly affected by light scattering may exhibit some dependence on wavelength as a result. Note that greater flexibility in specifying the MTF will be implemented in the future, but feel free to get in touch if this is required in the shorter term.</li>
</ol>
</div>
<div id="setting-scales-and-defining-objects" class="section level3" number="2.6.3">
<h3>
<span class="header-section-number">2.6.3</span> Setting Scales and Defining Objects<a class="anchor" aria-label="anchor" href="#setting-scales-and-defining-objects"><i class="fas fa-link"></i></a>
</h3>
<p>The other central purpose of <code><a href="http://pavo.colrverse.com/reference/procimg.html">procimg()</a></code> is centres on rotating and resizing images, setting a real-world image scale, and/or distinguishing the focal object from its background. Rotating an image simply requires inputting an angle, in degrees, by which the image is rotated about its centre, while resizing requires a scaling factor by which the size of image(s) are to be decreased or increased. Setting scales and distinguishing backgrounds, in contrast, are both interactive procedures, meaning that we are presented with the focal image and must select points on it using the mouse (either a line, when setting a scale, or a polygon when identifying the focus). If setting a scale, we specify a scale in our preferred units via <code>scaledist</code>, and then click the endpoints of the scale within the image (which could be a ‘formal’ scale, or simply the length of a wing or another known reference object). This information, as usual, is attached to the image as an attribute.</p>
<div class="sourceCode" id="cb102"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Interactively specify the real-world scale of the image.</span></span>
<span><span class="co"># Here 100 mm.</span></span>
<span><span class="va">butterflies</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://pavo.colrverse.com/reference/procimg.html">procimg</a></span><span class="op">(</span><span class="va">butterflies</span>, scaledist <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span></code></pre></div>
<p>Distinguishing a focal object from its background is important in cases where we are analysing a broader visual scene, particularly when the background is highly heterogeneous, such as an animal in nature, and cannot be classified into a homogeneous block and identified more simply (see below). To define the object and background we specify <code>outline = TRUE</code>, which will result in being asked to click around the outline of the focal object in each image, which is then converted to a polygon — the xy coordinates of which are saved as an attribute. It is often useful to slightly smooth the resulting polygon, which can be done with Chaikin’s corner-cutting algorithm by specifying a number of <code>refinements</code>. Chaikin’s algorithm works by iteratively replacing every point by two new points 1/4 of the way to the next. The argument <code>iterations</code> specifies the number of corner cutting iterations to apply, and the default value of 1 offers a subtle smoothing effect.</p>
<div class="sourceCode" id="cb103"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Interactively specify a smoothed polygon</span></span>
<span><span class="co"># around the focal objects</span></span>
<span><span class="va">butterflies</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://pavo.colrverse.com/reference/procimg.html">procimg</a></span><span class="op">(</span><span class="va">butterflies</span>,</span>
<span>  outline <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  iterations <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>All of these options can be simultaneously specified in a single call to <code><a href="http://pavo.colrverse.com/reference/procimg.html">procimg()</a></code>, and the <code>pavo 2.0</code> publication offers a useful example of such processing, since the more involved features are difficult to illustrate here due to their interactive nature.</p>

</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="index.html"><span class="header-section-number">1</span> Package Overview</a></div>
<div class="next"><a href="analysing-data.html"><span class="header-section-number">3</span> Analysing Data</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#importing-processing-and-visualising-data"><span class="header-section-number">2</span> Importing, Processing, and Visualising Data</a></li>
<li>
<a class="nav-link" href="#organizing-spectral-data"><span class="header-section-number">2.1</span> Organizing Spectral Data</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#spectral-dataset-description"><span class="header-section-number">2.1.1</span> Spectral Dataset Description</a></li>
<li><a class="nav-link" href="#importing-spectra"><span class="header-section-number">2.1.2</span> Importing spectra</a></li>
<li><a class="nav-link" href="#simulating-spectra"><span class="header-section-number">2.1.3</span> Simulating spectra</a></li>
<li><a class="nav-link" href="#subsetting-and-merging-spectral-data"><span class="header-section-number">2.1.4</span> Subsetting and Merging Spectral Data</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#processing-spectral-data"><span class="header-section-number">2.2</span> Processing Spectral Data</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#averaging-spectra"><span class="header-section-number">2.2.1</span> Averaging Spectra</a></li>
<li><a class="nav-link" href="#normalizing-and-smoothing-spectra"><span class="header-section-number">2.2.2</span> Normalizing and Smoothing Spectra</a></li>
<li><a class="nav-link" href="#binning-and-pca-analysis-of-spectral-shape"><span class="header-section-number">2.2.3</span> Binning and PCA Analysis of Spectral Shape</a></li>
<li><a class="nav-link" href="#dealing-with-negative-values-in-spectra"><span class="header-section-number">2.2.4</span> Dealing With Negative Values in Spectra</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#visualizing-spectral-data"><span class="header-section-number">2.3</span> Visualizing Spectral Data</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#the-plot-function-options"><span class="header-section-number">2.3.1</span> The plot Function Options</a></li>
<li><a class="nav-link" href="#the-aggplot-function"><span class="header-section-number">2.3.2</span> The aggplot() Function</a></li>
</ul>
</li>
<li><a class="nav-link" href="#organizing-spatial-image-data"><span class="header-section-number">2.4</span> Organizing Spatial (image) Data</a></li>
<li>
<a class="nav-link" href="#visualising-image-data"><span class="header-section-number">2.5</span> Visualising Image Data</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#the-plot-and-summary-functions"><span class="header-section-number">2.5.1</span> The plot and summary Functions</a></li></ul>
</li>
<li>
<a class="nav-link" href="#processing-image-data"><span class="header-section-number">2.6</span> Processing Image Data</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#overview"><span class="header-section-number">2.6.1</span> Overview</a></li>
<li><a class="nav-link" href="#filtering-images-to-model-the-visual-acuity-of-animals"><span class="header-section-number">2.6.2</span> Filtering images to model the visual acuity of animals</a></li>
<li><a class="nav-link" href="#setting-scales-and-defining-objects"><span class="header-section-number">2.6.3</span> Setting Scales and Defining Objects</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/colrverse/colsci-book/blob/master/01-importing_processing.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/colrverse/colsci-book/edit/master/01-importing_processing.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>The pavo handbook: studying biological colouration in R</strong>" was written by . It was last built on 2024-06-07.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
